FROM nvidia/cuda:12.3.2-cudnn9-runtime-ubuntu22.04


RUN apt-get update && apt-get install -y --no-install-recommends \
python3.11 python3-pip ffmpeg libsndfile1 git \
&& rm -rf /var/lib/apt/lists/*


# FROM nvidia/cuda:12.8.0-devel-ubuntu22.04

# RUN apt-get update && apt-get install -y --no-install-recommends \
# python3.12 python3-pip ffmpeg libsndfile1 git \
# && rm -rf /var/lib/apt/lists/*


COPY requirements.txt ./
RUN pip install --no-cache-dir --upgrade pip
RUN pip install --no-cache-dir -r requirements.txt

WORKDIR /app

# COPY . .

ENV MODEL_NAME=zipvoice
ENV MODEL_DIR="/app/models/" 
#/media/nampv1/hdd/models/tts/zipvoice_ft/
ENV CHECKPOINT_NAME="exp/zipvoice_finetune/checkpoint-4000.pt" 
ENV VOCODER_DIRNAME="vocoder/charactr--vocos-mel-24khz"

#base/model.pt
ENV TOKENIZER=espeak
ENV LANG=vi
ENV TOKENS_FILE="base/tokens.txt"
ENV MODEL_CONFIG_FILE="base/mode 
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "13082"]


# Usage
# Build docker image
# sudo docker build --no-cache -t vnpost-tts-service-1.0:zipvoice .

# Run docker with nvidia runtime
sudo docker run --gpus '"device=0"' --env VOCODER_DIRNAME=vocoder/charactr--vocos-mel-24khz -it --rm \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/demo/backend:/app \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/demo/backend/models/:/app/models \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/zipvoice:/app/zipvoice \
-p 13082:13082 vnpost-tts-service-1.0:zipvoice


sudo docker run -d \
--env DEVICE=cpu \
--env CHECKPOINT_NAME=exp/zipvoice_finetune/checkpoint-4000.pt \
--env ASR_API_ENDPOINT=https://ai.vnpost.vn/voiceai/core/stt/v1/file \
-it \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/demo/backend:/app \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/demo/backend/models/:/app/models \
-v /home/nampv1/projects/tts/tts-ft/ZipVoice/zipvoice:/app/zipvoice \
-p 13082:13082 vnpost-tts-service-1.0:zipvoice



docker run --gpus '"device=0"' -it \
-v /home/dmst_ai/nampv1/tts-zipvoice-ft/demo/backend:/app \
-v /home/dmst_ai/nampv1/models/tts/zipvoice_ft/:/app/models \
-v /home/dmst_ai/nampv1/tts-zipvoice-ft/zipvoice:/app/zipvoice \
-p 13082:13082 vnpost-tts-service-1.0:zipvoice


